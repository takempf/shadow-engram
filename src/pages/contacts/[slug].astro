---
import { db, Contact, eq } from 'astro:db'; // Removed unused table imports
import Layout from '../../layouts/Layout.astro';
import ContactDetail from '../../components/ContactDetail.svelte';

export async function getStaticPaths() {
  const contacts = await db.select({ slug: Contact.slug }).from(Contact).all();
  return contacts.map(c => {
    if (!c.slug) {
      // Consider how to handle contacts without slugs if critical for path generation
      // For now, skipping them as before
      console.warn(`A contact is missing a slug. Skipping path generation.`);
      return null;
    }
    return {
      params: { slug: c.slug },
      props: { slug: c.slug },
    };
  }).filter(path => path !== null);
}

const { slug } = Astro.props;
// Fetch basic contact info to get ID for delete link and to pass to Svelte component
// The Svelte component will re-fetch comprehensive details including related entities.
const contact = await db.select({ id: Contact.id, slug: Contact.slug, FirstName: Contact.FirstName, LastName: Contact.LastName }).from(Contact).where(eq(Contact.slug, slug)).get();

// Determine a display name for the page title (can be refined)
let pageTitle = "Contact Detail";
if (contact) {
  pageTitle = `${contact.FirstName || ''} ${contact.LastName || ''}`.trim() || contact.slug || "Contact";
} else {
  pageTitle = "Contact Not Found";
}
---
<Layout title={pageTitle}>
  {contact ? (
    <>
      {/* The ContactDetail Svelte component will handle display and fetching of all details */}
      <ContactDetail client:load contactId={contact.id} />

      <div class="contact-actions mt-8 flex justify-start space-x-4">
        <a href={`/delete-contact/${contact.id}`} class="button-danger">Delete this contact</a>
      </div>
      <p class="mt-6"><a href="/" class="text-blue-600 hover:underline dark:text-blue-400">Back to Contacts</a></p>
    </>
  ) : (
    <>
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Contact Not Found</h1>
      <p class="text-gray-600 dark:text-gray-400">The contact with slug '{slug}' could not be found.</p>
      <p class="mt-6"><a href="/" class="text-blue-600 hover:underline dark:text-blue-400">Back to Contacts</a></p>
    </>
  )}
</Layout>
